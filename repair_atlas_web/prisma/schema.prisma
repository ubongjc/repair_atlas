// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================================
// Core Entities
// ============================================================

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     Item[]
  defects   Defect[]
  fixPaths  FixPath[]
  toolLoans ToolLoan[]

  @@index([clerkId])
  @@index([email])
}

enum UserRole {
  USER
  PRO
  ADMIN
}

model Item {
  id          String   @id @default(cuid())
  userId      String
  category    String // electronics, appliances, furniture, etc.
  brand       String?
  model       String?
  modelNumber String?
  serialNo    String?
  photoUrls   String[] // R2 URLs (encrypted if sensitive)

  // AI-extracted metadata
  identifiedAt DateTime?
  confidence   Float?
  metadata     Json? // flexible field for device-specific data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  defects Defect[]

  @@index([userId])
  @@index([category])
  @@index([brand, model])
}

model Defect {
  id          String   @id @default(cuid())
  itemId      String
  userId      String
  symptoms    String[] // user-reported symptoms
  description String?
  photoUrls   String[] // condition photos (encrypted)
  severity    Severity @default(MEDIUM)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item     Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fixPaths FixPath[]

  @@index([itemId])
  @@index([userId])
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model FixPath {
  id             String   @id @default(cuid())
  defectId       String
  userId         String
  title          String
  steps          Json // array of step objects with instructions, media, etc.
  estimatedTime  Int? // minutes
  difficulty     Difficulty @default(MEDIUM)
  riskLevel      RiskLevel  @default(MEDIUM)

  // Warranty & Safety
  warrantyImpact    String? // "voids", "preserves", "unknown"
  safetyWarnings    String[]
  requiredSkills    String[]

  // Cost & Parts
  estimatedCost     Float?
  currency          String @default("USD")

  // Provenance & Trust
  sourceType        SourceType @default(COMMUNITY)
  sourceUrl         String?
  verifiedAt        DateTime?
  verifiedBy        String?
  provenanceScore   Float? // 0-1, higher is more trustworthy

  // Embeddings for semantic search
  embedding         Unsupported("vector(1536)")? // pgvector for semantic search

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  defect Defect @relation(fields: [defectId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  parts  Part[]

  @@index([defectId])
  @@index([userId])
  @@index([sourceType])
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SourceType {
  OFFICIAL // manufacturer
  IFIXIT   // verified repair guide site
  COMMUNITY
  AI_GENERATED
}

model Part {
  id               String   @id @default(cuid())
  fixPathId        String
  name             String
  partNumber       String?
  compatibleModels String[]
  estimatedCost    Float?
  currency         String   @default("USD")

  // Affiliate & Purchasing
  affiliateUrl     String?
  availability     Availability @default(UNKNOWN)

  // Crosswalk compatibility
  alternativePartNumbers String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fixPath FixPath @relation(fields: [fixPathId], references: [id], onDelete: Cascade)

  @@index([fixPathId])
  @@index([partNumber])
}

enum Availability {
  IN_STOCK
  LIMITED
  OUT_OF_STOCK
  DISCONTINUED
  UNKNOWN
}

// ============================================================
// Tool Libraries & Lending
// ============================================================

model ToolLibrary {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  state       String?
  country     String
  postalCode  String?
  latitude    Float
  longitude   Float

  contactEmail String?
  contactPhone String?
  website      String?

  hours        Json? // operating hours
  membership   Json? // membership requirements/costs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tools Tool[]

  @@index([city, state])
  @@index([latitude, longitude])
}

model Tool {
  id          String   @id @default(cuid())
  libraryId   String
  name        String
  category    String // power tools, hand tools, diagnostic, etc.
  brand       String?
  model       String?
  condition   String?
  available   Boolean  @default(true)

  loanPeriodDays Int @default(7)
  depositAmount  Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  library ToolLibrary @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  loans   ToolLoan[]

  @@index([libraryId])
  @@index([category])
}

model ToolLoan {
  id         String   @id @default(cuid())
  toolId     String
  userId     String
  borrowedAt DateTime @default(now())
  dueAt      DateTime
  returnedAt DateTime?

  status LoanStatus @default(ACTIVE)
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tool Tool @relation(fields: [toolId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([toolId])
  @@index([userId])
  @@index([status])
}

enum LoanStatus {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
}

// ============================================================
// Billing & Entitlements
// ============================================================

model Subscription {
  id               String             @id @default(cuid())
  clerkUserId      String             @unique
  stripeCustomerId String             @unique
  stripePriceId    String
  status           SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd DateTime
  cancelAtPeriodEnd Boolean          @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkUserId])
  @@index([stripeCustomerId])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}
